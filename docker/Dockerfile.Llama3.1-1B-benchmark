FROM vllm/vllm-openai:v0.8.3

WORKDIR /app 


# ENV HF_ENDPOINT=https://hf-mirror.com
# RUN huggingface-cli download --resume-download yang31210999/Llama3.1-1B-Neo-BAAI-1000k --local-dir /models/Llama3.1-1B
RUN sed -i 's|http://archive.ubuntu.com/ubuntu/|http://mirrors.aliyun.com/ubuntu/|g' /etc/apt/sources.list
RUN apt update && apt install -y git
RUN pip install toml
RUN pip install pandas

RUN echo '[model]' >> conf.toml && \
    echo 'MODEL_NAME = "Llama3.1-1B"' >> conf.toml && \
    echo 'PORT = 6018' >> conf.toml

COPY vllm_start vllm_start
COPY benchmark benchmark

# 创建启动脚本
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'python3 -u vllm_start/vllm_start_up.py &' >> /app/start.sh && \
    echo 'sleep 20' >> /app/start.sh && \
    echo 'python3 -u benchmark/benchmark_prefix_caching.py' >> /app/start.sh && \
    chmod +x /app/start.sh

# 修改 CMD 指令
ENTRYPOINT ["/bin/bash", "/app/start.sh"]